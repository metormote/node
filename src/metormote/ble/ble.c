/*
 * ble.c
 *
 * Created: 10/14/2012 12:54:05 PM
 *  Author: Administrator
 */ 
#include "ble.h"

#define PROTOBUF_IN_PIPE    1
#define PROTOBUF_OUT_PIPE   2
static const uint8_t setup_data[32][32] PROGMEM = {
  {0x07,0x06,0x00,0x00,0x02,0x02,0x41,0xd7,},
  {0x1f,0x06,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x00,0x02,0x00,0x04,0x00,0x00,0x06,0x00,0x05,0xd0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xaa,},
  {0x1e,0x06,0x10,0x1c,0xaa,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x03,0x90,0x01,},
  {0x1f,0x06,0x20,0x00,0x04,0x04,0x02,0x02,0x00,0x01,0x28,0x00,0x01,0x00,0x18,0x04,0x04,0x05,0x05,0x00,0x02,0x28,0x03,0x01,0x02,0x03,0x00,0x00,0x2a,0x04,0x04,0x14,},
  {0x1f,0x06,0x20,0x1c,0x09,0x00,0x03,0x2a,0x00,0x01,0x4d,0x65,0x74,0x6f,0x72,0x6d,0x6f,0x74,0x65,0x69,0x2e,0x63,0x6f,0x6d,0x00,0x00,0x00,0x00,0x00,0x00,0x04,0x04,},
  {0x1f,0x06,0x20,0x38,0x05,0x05,0x00,0x04,0x28,0x03,0x01,0x02,0x05,0x00,0x01,0x2a,0x06,0x04,0x03,0x02,0x00,0x05,0x2a,0x01,0x01,0xaa,0xaa,0x04,0x04,0x05,0x05,0x00,},
  {0x1f,0x06,0x20,0x54,0x06,0x28,0x03,0x01,0x02,0x07,0x00,0x04,0x2a,0x06,0x04,0x09,0x08,0x00,0x07,0x2a,0x04,0x01,0xff,0xff,0xff,0xff,0x00,0x00,0xff,0xff,0x04,0x04,},
  {0x1f,0x06,0x20,0x70,0x02,0x02,0x00,0x08,0x28,0x00,0x01,0x01,0x18,0x04,0x04,0x10,0x10,0x00,0x09,0x28,0x00,0x01,0x52,0x43,0x43,0x35,0x42,0x00,0x00,0x80,0x00,0x20,},
  {0x1f,0x06,0x20,0x8c,0x00,0x00,0xaa,0xaa,0x00,0x00,0x04,0x04,0x13,0x13,0x00,0x0a,0x28,0x03,0x01,0x04,0x0b,0x00,0x52,0x43,0x43,0x35,0x42,0x00,0x00,0x80,0x00,0x20,},
  {0x1f,0x06,0x20,0xa8,0x00,0x00,0xab,0xaa,0x00,0x00,0x44,0x10,0x14,0x00,0x00,0x0b,0xaa,0xab,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,},
  {0x1f,0x06,0x20,0xc4,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x04,0x04,0x13,0x13,0x00,0x0c,0x28,0x03,0x01,0x20,0x0d,0x00,0x52,0x43,0x43,0x35,0x42,0x00,0x00,0x80,0x00,},
  {0x1f,0x06,0x20,0xe0,0x20,0x00,0x00,0xac,0xaa,0x00,0x00,0x24,0x00,0x14,0x00,0x00,0x0d,0xaa,0xac,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,},
  {0x17,0x06,0x20,0xfc,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x46,0x14,0x03,0x02,0x00,0x0e,0x29,0x02,0x01,0x00,0x00,0x00,},
  {0x17,0x06,0x40,0x00,0xaa,0xab,0x02,0x00,0x08,0x04,0x00,0x0b,0x00,0x00,0xaa,0xac,0x02,0x00,0x04,0x04,0x00,0x0d,0x00,0x0e,},
  {0x13,0x06,0x50,0x00,0x52,0x43,0x43,0x35,0x42,0x00,0x00,0x80,0x00,0x20,0x00,0x00,0x00,0x00,0x00,0x00,},
  {0x06,0x06,0xf0,0x00,0x02,0x56,0x7d,},
};

static ATOM_SEM connect_sem;

void ble_init() {
  atomSemCreate(&connect_sem, 0);
  
  ble_core_init();
  
  ble_reset();
}


int8_t ble_reset() {
  uint_farptr_t ptr;
  
  atomSemResetCount(&connect_sem, 0);
  
  ble_core_reset();
  
  ptr=pgm_get_far_address(setup_data);
  return ble_core_setup(ptr);
}

int8_t ble_start(void (*callback)(ble_events_t event, uint8_t *data, uint16_t)) {
  int8_t status;
  struct ble_aci_packet_t aci;
  uint8_t *ptr, *buf;
  uint16_t len;
  
  for(;;) {
    buf=NULL;
    ptr=NULL;
    len=0;
    
    status=ble_core_connect(0, 0x1000);
    callback(BLE_EVENT_CONNECTING, NULL, 0);
    
    if(status==STATUS_OK 
      && ble_core_wait_for_pipe(BLE_PIPE_PROTOBUF_IN, 10*SYSTEM_TICKS_PER_SEC)==STATUS_OK
      && ble_core_wait_for_pipe(BLE_PIPE_PROTOBUF_OUT, 5*SYSTEM_TICKS_PER_SEC)==STATUS_OK) {
      
      ble_core_change_timing_request(6, 10, 2, 1000);
      
      atomSemPut(&connect_sem);
      
      callback(BLE_EVENT_CONNECTED, NULL, 0);
      
      for(;;) {
        while(atomQueueGet(&ble_rx_queue, SYSTEM_TICKS_PER_SEC, (uint8_t *)&aci)==STATUS_OK) {
          if(buf==NULL) {
            len=aci.pdu[1];
            len&=((0xFFFF & aci.pdu[2]) << 8);
            if(aci.pdu[0]!=BLE_PIPE_PROTOBUF_IN || len > 256) {
              atomSemGet(&connect_sem, -1);
              ble_core_disconnect(0x1);
              break;
            }
            
            buf=mem_safe_malloc(len);
            if(buf==NULL) {
              break;
            }
            memcpy(buf, aci.pdu+3, BLE_BLOCK_LEN-2);
            ptr=buf+BLE_BLOCK_LEN-2;
          }
          else if((ptr-buf)<len) {
            memcpy(ptr, aci.pdu+1, BLE_BLOCK_LEN);
            ptr+=BLE_BLOCK_LEN;
          }
          else {
            atomSemGet(&connect_sem, -1);
            ble_core_disconnect(0x1);
            status=ERR_PROTOCOL;
            break;
          }
          
          if((ptr-buf)>=len) {
            status=STATUS_OK;
            break;
          }
        }
        
        if(buf!=NULL && status==STATUS_OK) {
          callback(BLE_EVENT_DATA, buf, len);
        }
        
        if(buf!=NULL) {
          mem_safe_free(buf);
          buf=NULL;
        }
        
        if(status!=STATUS_OK || !ble_core_is_connected()) {
          atomSemGet(&connect_sem, -1);
          ble_core_clear_rx_buffer();
          callback(BLE_EVENT_DISCONNECT, NULL, 0);
          break;
        }
      }
    }
    else {
      if(ble_is_connected()) {
        ble_core_disconnect(BLE_DISCONNECT_REASON_USER);
      }
      ble_core_clear_rx_buffer();
      callback(BLE_EVENT_DISCONNECT, NULL, 0);
      atomTimerDelay(SYSTEM_TICKS_PER_SEC);
    }
  }
  return status;
}

bool ble_is_connected() {
  if(!ble_core_is_connected()) {
    return false;
  }
  
  if(atomSemGet(&connect_sem, -1)==ATOM_WOULDBLOCK) {
    return false;
  }
  
  atomSemPut(&connect_sem);
  return true;
}

void ble_standby() {
  ble_core_standby(true);
}

void ble_resume() {
  ble_core_standby(false);
}

int8_t ble_send(uint8_t *data, uint16_t len) {
  int8_t status=STATUS_OK;
  uint16_t i, data_len;
  uint8_t no_of_pgks, last_data_len;
  uint8_t *ptr;
  
  if(!ble_is_connected()) {
    return ERR_IO_ERROR;
  }
  
  if(ble_core_wait_for_pipe(BLE_PIPE_PROTOBUF_IN, 5*SYSTEM_TICKS_PER_SEC)!=STATUS_OK) {
    return ERR_IO_ERROR;
  }
  if(ble_core_wait_for_pipe(BLE_PIPE_PROTOBUF_OUT, 5*SYSTEM_TICKS_PER_SEC)!=STATUS_OK) {
    return ERR_IO_ERROR;
  }
  
  data_len=sizeof(uint16_t)+len;
  no_of_pgks=data_len / BLE_BLOCK_LEN;
  last_data_len=data_len % BLE_BLOCK_LEN;
  if(last_data_len>0) {
    no_of_pgks++;
  }
  else {
    last_data_len=BLE_BLOCK_LEN;
  }
  ptr=data;
  
  for(i=0;i<no_of_pgks; i++) {
    
    if(i==no_of_pgks-1) {
      status=ble_core_send_data(BLE_PIPE_PROTOBUF_OUT, ptr, last_data_len, true);
    }
    else {
      status=ble_core_send_data(BLE_PIPE_PROTOBUF_OUT, ptr, BLE_BLOCK_LEN, true);
      ptr+=BLE_BLOCK_LEN;
    }
    
    if(status!=STATUS_OK)
      break;
  }
  
  return status;
}


int8_t ble_set_device_id(uint64_t device_id) {
  return ble_core_set_local_data(BLE_PIPE_DEVICE_ID, (uint8_t *)&device_id, 8);
}